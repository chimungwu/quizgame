<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>平方測驗 - 自訂範圍與題數</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial, sans-serif; padding: 20px; background: #f5f7fa; color: #222; }
    h1 { margin: 0 0 10px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 16px; }
    .group { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px 10px; display: inline-flex; align-items: center; gap: 6px; }
    .group label { color: #555; font-size: 14px; }
    input[type=number], select { width: 80px; padding: 6px 8px; border: 1px solid #cfd6e1; border-radius: 8px; }
    button { padding: 8px 14px; border: 0; border-radius: 999px; background: #2563eb; color: #fff; cursor: pointer; }
    button.secondary { background: #6b7280; }
    .question { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 8px 0; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .question input[type=number] { width: 140px; }
    .correct { color: #10b981; }
    .wrong { color: #ef4444; }
    #quiz { margin-top: 8px; }
    #result { margin-top: 14px; }
    .muted { color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <h1>平方測驗</h1>
  <div class="controls">
    <div class="group">
      <label for="min">範圍</label>
      <input id="min" type="number" value="1" min="1" max="100" />
      <span>到</span>
      <input id="max" type="number" value="100" min="1" max="100" />
    </div>
    <div class="group">
      <label for="count">題數</label>
      <select id="count">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>
    <button id="startBtn">開始測驗</button>
    <span class="muted">（範圍僅限 1–100；題目隨機且不重複）</span>
  </div>

  <form id="quiz"></form>
  <div id="result"></div>

  <script>
    let questions = [];

    function clampRangeInputs(){
      const minEl = document.getElementById('min');
      const maxEl = document.getElementById('max');
      let min = parseInt(minEl.value || '1', 10);
      let max = parseInt(maxEl.value || '100', 10);
      // 將輸入限制在 1..100
      min = Math.min(100, Math.max(1, min));
      max = Math.min(100, Math.max(1, max));
      // 確保 min <= max
      if (min > max) [min, max] = [max, min];
      minEl.value = String(min);
      maxEl.value = String(max);
      return {min, max};
    }

    function startQuiz(){
      const {min, max} = clampRangeInputs();
      const count = parseInt(document.getElementById('count').value, 10);

      const rangeSize = max - min + 1;
      if (count > rangeSize){
        alert(`題數（${count}）不可超過範圍內可用數量（${rangeSize}）。\n請放大範圍或降低題數。`);
        return;
      }

      // 產生不重複隨機題目
      const set = new Set();
      while (set.size < count){
        set.add(Math.floor(Math.random() * rangeSize) + min);
      }
      questions = [...set];

      // 顯示題目
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = '';
      questions.forEach((q,i)=>{
        const div = document.createElement('div');
        div.className = 'question';
        div.innerHTML = `
          <label for="ans${i}">${i+1}. <strong>${q}</strong> 的平方 =</label>
          <input type="number" id="ans${i}" name="ans${i}" inputmode="numeric" />
        `;
        quiz.appendChild(div);
      });

      // 加入提交按鈕
      const actions = document.createElement('div');
      actions.style.marginTop = '10px';
      const submitBtn = document.createElement('button');
      submitBtn.type = 'button';
      submitBtn.textContent = '交卷';
      submitBtn.className = 'secondary';
      submitBtn.onclick = checkAnswers;
      actions.appendChild(submitBtn);
      quiz.appendChild(actions);

      document.getElementById('result').innerHTML = '';
      // 聚焦第一題
      document.getElementById('ans0')?.focus();
    }

    function checkAnswers(){
      const quiz = document.getElementById('quiz');
      const result = document.getElementById('result');
      result.innerHTML = '';

      let score = 0;
      const details = [];

      questions.forEach((q,i)=>{
        const input = document.getElementById(`ans${i}`);
        const val = input && input.value.trim() !== '' ? Number(input.value) : NaN;
        const correct = q*q;
        if (val === correct){
          score++;
          details.push(`<div class='correct'>第 ${i+1} 題 ✔ 正確</div>`);
        } else {
          details.push(`<div class='wrong'>第 ${i+1} 題 ✘ 錯誤，正確答案是 <strong>${correct}</strong></div>`);
        }
      });

      const total = questions.length;
      const percent = Math.round(score / total * 100);
      result.innerHTML = `<h3>你的分數：${score} / ${total}（${percent}%）</h3>` + details.join('');
    }

    // 事件綁定與輸入限制監控
    document.getElementById('startBtn').addEventListener('click', startQuiz);
    ['min','max'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', clampRangeInputs);
      el.addEventListener('blur', clampRangeInputs);
      el.addEventListener('input', ()=>{
        // 只允許數字，並避免無限長度
        const cleaned = el.value.replace(/[^0-9]/g, '').slice(0,3);
        el.value = cleaned;
      });
    });
  </script>
</body>
</html>
