<!doctype html>
<html lang="zh-Hant">
<head>
<!-- 書籤/分頁 icon -->
<link rel="icon" type="image/png" href="favicon.png" />
<!-- iPhone/iPad 主畫面 icon -->
<link rel="apple-touch-icon" href="favicon.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>數學練習（台灣學童版）—方塊題卡</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#2563eb;
      --ok:#16a34a; --err:#dc2626; --warn:#f59e0b; --ring:rgba(37,99,235,.15);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink)}
    .wrap{max-width:980px;margin:auto; padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:clamp(20px,3.4vw,28px);margin:0}
    .sub{color:var(--muted); font-size:14px}

    .panel{margin-top:12px; background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .group{display:flex;align-items:center;gap:6px; background:#f9fafb; border:1px solid #e5e7eb; padding:8px 10px; border-radius:12px}
    label{color:#374151;font-size:14px}
    select,input[type=number]{padding:8px 10px; border:1px solid #cfd6e1; border-radius:10px; background:#fff; min-width:80px}
    button{appearance:none;border:0;border-radius:999px; padding:10px 16px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer}
    button.ghost{background:transparent;color:#374151;border:1px solid #d1d5db}

    .grid{display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:12px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px; box-shadow:0 1px 0 #f3f4f6}
    .q-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .badge{font-size:12px;color:#6b7280;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px}
    .expr{font-size:22px; font-weight:700; letter-spacing:.4px}
    .ans{margin-top:8px; display:flex; gap:8px; align-items:center}
    .ans input{flex:1; padding:10px 12px; border:1px solid #cfd6e1; border-radius:10px}
    .flag{font-size:12px;color:#6b7280}
    .flag.ok{color:var(--ok)}
    .flag.err{color:var(--err)}

    .reveal-text{margin-top:6px;font-size:13px;color:#047857}

    .summary{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .meter{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .meter i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22c55e,#4ade80)}

    .hint{margin-top:6px;font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>數學練習（台灣學童版）</h1>
        <div class="sub">題目以「方塊題卡」呈現，適合國小～國中。支援：平方、平方根、四則（可選混合）。</div>
      </div>
      <div class="sub">小技巧：輸入答案後按 Enter 會跳到下一題。</div>
    </header>

    <section class="panel">
      <div class="controls" role="group" aria-label="設定">
        <div class="group">
          <label for="type">題型</label>
          <select id="type">
            <option value="square">平方（n²）</option>
            <option value="squareroot">平方根（√n）</option>
            <option value="add">加法</option>
            <option value="sub">減法</option>
            <option value="mul">乘法</option>
            <option value="div">除法（含餘數）</option>
            <option value="mix4">混合四則</option>
          </select>
        </div>
        <div class="group">
          <label for="min">範圍</label>
          <input id="min" type="number" value="1" min="1" max="100" />
          <span>到</span>
          <input id="max" type="number" value="20" min="1" max="100" />
        </div>
        <div class="group">
          <label for="count">題數</label>
          <select id="count">
            <option>5</option>
            <option selected>10</option>
            <option>15</option>
            <option>20</option>
          </select>
        </div>
        <button id="btnStart">開始出題</button>
      </div>
      <div class="hint">＊除法會同時顯示「商」與「餘數」。平方根會以「可整開」為主（如 4, 9, 16, …）。</div>
    </section>

    <section class="panel">
      <div id="quiz" class="grid" aria-live="polite"></div>
      <div style="margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap">
        <strong id="scoreText">尚未交卷</strong>
        <span class="badge" id="progress">0 / 0 完成</span>
        <div class="meter" style="flex:1; min-width:200px"><i id="meter"></i></div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnSubmit" class="ghost">交卷批改</button>
        <button id="btnReveal" class="ghost">顯示答案</button>
      </div>
    </section>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function sampleDistinct(min,max,count){
      const size = max-min+1; if (count>size) count = size;
      const set = new Set(); while(set.size<count){ set.add(rand(min,max)); }
      return [...set];
    }

    function perfectSquaresIn(min,max){
      const arr=[]; const s= Math.ceil(Math.sqrt(min)); const e = Math.floor(Math.sqrt(max));
      for(let n=s;n<=e;n++) arr.push(n*n);
      return arr;
    }

    function makeQuestions({type,min,max,count}){
      min = clamp(min,1,100); max = clamp(max,1,100); if(min>max) [min,max]=[max,min];
      const qs=[]; const seen=new Set();

      const keyFor=(op,a,b)=>`${op}:${a},${b}`;

      if(type==='square'){
        sampleDistinct(min,max,count).forEach((n)=>qs.push({kind:'square',text:`${n} 的平方 =`,answer:n*n}));
        return qs;
      }

      if(type==='squareroot'){
        const ps = perfectSquaresIn(min,max);
        if(ps.length===0){ alert('範圍內沒有可以整開的平方數'); return []; }
        ps.slice(0,count).forEach(v=>qs.push({kind:'squareroot',text:`√${v} =`,answer:Math.sqrt(v)}));
        return qs;
      }

      const ops = type==='mix4'?['add','sub','mul','div']:[type];
      let attempts=0; const LIMIT=count*50;
      while(qs.length<count && attempts<LIMIT){
        attempts++;
        const op=ops[rand(0,ops.length-1)]; let a,b,expr,ans;
        if(op==='add'){a=rand(min,max); b=rand(min,max); expr=`${a} + ${b} =`; ans=a+b;}
        else if(op==='sub'){a=rand(min,max); b=rand(min,max); if(a<b)[a,b]=[b,a]; expr=`${a} − ${b} =`; ans=a-b;}
        else if(op==='mul'){a=rand(min,max); b=rand(min,max); expr=`${a} × ${b} =`; ans=a*b;}
        else if(op==='div'){
          b=rand(1,Math.min(max,12)); a=rand(min,max);
          const quotient=Math.floor(a/b); const remainder=a%b;
          expr=`${a} ÷ ${b} = (商 ___, 餘數 ___)`;
          ans={q:quotient,r:remainder,divisor:b};
        }
        const key=keyFor(op,a,b);
        if(seen.has(key)) continue; seen.add(key);
        qs.push({kind:op,text:expr,answer:ans});
      }
      return qs;
    }

    let currentQs=[];

    function renderQuiz(qs){
      const host=$('#quiz'); host.innerHTML='';
      qs.forEach((q,idx)=>{
        const card=document.createElement('div'); card.className='card';
        let inputHtml="";
        if(q.kind==='div'){
          inputHtml=`<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="商" data-sub="q" data-idx="${idx}" />
                     <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="餘數" data-sub="r" data-idx="${idx}" />`;
        }else{
          inputHtml=`<input type="number" inputmode="numeric" pattern="[0-9]*" data-sub="ans" data-idx="${idx}" />`;
        }
        card.innerHTML=`
          <div class="q-title"><span class="badge">第 ${idx+1} 題</span><span class="badge" data-role="flag"></span></div>
          <div class="expr">${q.text}</div>
          <div class="ans">${inputHtml}<button class="ghost" data-act="check" data-idx="${idx}">檢查</button></div>
          <div class="reveal-text" data-role="reveal"></div>`;
        host.appendChild(card);
      });
      host.onclick=onCardClick; host.onkeydown=onKeyEnterNext;
    }

    function onCardClick(e){
      const btn=e.target.closest('button[data-act="check"]');
      if(!btn)return; const idx=+btn.dataset.idx; checkOne(idx);
    }

    function onKeyEnterNext(e){
      if(e.key!=='Enter')return; const inp=e.target.closest('input[type="number"]');
      if(!inp)return; e.preventDefault();
      const idx=+inp.dataset.idx; const sub=inp.dataset.sub;
      if(inp.value.trim()!=='') checkOne(idx,true);
      let next;
      if(sub==='q') next=$(`#quiz input[data-idx="${idx}"][data-sub="r"]`);
      else next=$(`#quiz input[data-idx="${idx+1}"][data-sub]`);
      if(next) next.focus(); else $('#btnSubmit').focus();
    }

    function checkOne(idx,silent=false){
      const card=$$('#quiz .card')[idx]; const flag=card.querySelector('[data-role="flag"]');
      const q=currentQs[idx]; let ok=false;
      if(q.kind==='div'){
        const qVal=card.querySelector('input[data-sub="q"]').value.trim();
        const rVal=card.querySelector('input[data-sub="r"]').value.trim();
        if(qVal!=='' && rVal!==''){
          ok=(Number(qVal)===q.answer.q && Number(rVal)===q.answer.r && Number(rVal)<q.answer.divisor);
        }
      }else{
        const val=card.querySelector('input[data-sub="ans"]').value.trim();
        if(val!=='') ok=(Number(val)===Number(q.answer));
      }
      flag.textContent=ok?'✔ 正確':'✘ 錯誤'; flag.className='badge '+(ok?'flag ok':'flag err');
      return ok;
    }

    function submitAll(){
      let score=0; currentQs.forEach((_,i)=>{ if(checkOne(i,true)) score++; });
      const total=currentQs.length; const pct=Math.round(score/total*100);
      $('#scoreText').textContent=`成績：${score} / ${total}（${pct}%）`; $('#meter').style.width=pct+'%';
    }

    function reveal(){
      $$('#quiz .card').forEach((card,i)=>{
        const show=card.querySelector('[data-role="reveal"]');
        const q=currentQs[i];
        if(q.kind==='div'){
          show.textContent=`正解：商 ${q.answer.q}, 餘數 ${q.answer.r}`;
        }else{
          show.textContent=`正解：${q.answer}`;
        }
      });
    }

    $('#btnStart').onclick=()=>{
      const type=$('#type').value; let min=parseInt($('#min').value||'1',10); let max=parseInt($('#max').value||'100',10);
      min=clamp(min,1,100); max=clamp(max,1,100); if(min>max)[min,max]=[max,min];
      const count=parseInt($('#count').value,10);
      currentQs=makeQuestions({type,min,max,count});
      renderQuiz(currentQs); $('#scoreText').textContent='尚未交卷'; $('#meter').style.width='0%';
    };
    $('#btnSubmit').onclick=submitAll;
    $('#btnReveal').onclick=reveal;
  </script>
</body>
</html>
