<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- æ›¸ç±¤/åˆ†é  icon -->
  <link rel="icon" type="image/png" href="favicon1.png" />
  <!-- iPhone/iPad ä¸»ç•«é¢ icon -->
  <link rel="apple-touch-icon" href="favicon1.png" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…©ä½æ•¸ä¹˜æ³•é€Ÿç®—ï½œç·´ç¿’ & æ¸¬é©—</title>

  <style>
/* ========== å…¨åŸŸè®Šæ•¸èˆ‡åŸºç¤æ¨£å¼ï¼ˆæ¸…æ–°è—ç¶ ï¼‰ ========== */
:root{
  /* ä¸»é¡Œè‰²ç¥¨ */
  --bg:            #fdfdf9;   /* ç¶²é èƒŒæ™¯ï¼ˆå¾ˆæ·¡çš„è—ç¶ ç™½ï¼‰ */
  --card:          #fffefc;   /* å¡ç‰‡/é¡Œç›®åº• */
  --card-2:        #f7f3ed;   /* æ¬¡ç´šåº•ï¼ˆé¸é …/å›é¡§ï¼‰ */
  --card-3:        #a7e4eb;   /* hover/active è¼ƒæ·±ä¸€é» */
  --border:        #dcd7d0;   /* é‚Šæ¡† */
  --txt:           #222222;   /* ä¸»è¦æ–‡å­—ï¼ˆæ·±é’ï¼‰ */
  --txt-weak:      #555555;   /* æ¬¡è¦æ–‡å­— */
  --accent:        #00838f;   /* å¼·èª¿è‰²ï¼ˆé’è—ï¼‰ */
  --good:          #2e7d32;   /* æ­£ç¢º */
  --bad:           #c62828;   /* éŒ¯èª¤ */

  /* è§¸æ§å°ºå¯¸ */
  --tap-min: 48px;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background: linear-gradient(180deg, #f6fdff, var(--bg) 40%, #edf9fb);
  color: var(--txt);
  display:flex;
  min-height:100vh;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.wrap{ width:min(1000px,100%); display:grid; gap:16px; }

.card{
  background: var(--card);
  border:1px solid var(--border);
  border-radius:20px;
  padding:20px;
  backdrop-filter:saturate(1.05) blur(2px);
  /* æ·ºè‰²ä¸»é¡Œç”¨æŸ”å’Œé™°å½± */
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

h1{ margin:0 0 6px; font-size:clamp(28px,4vw,40px); }
.sub{ opacity:.95; font-size:14px; margin-bottom:12px; line-height:1.6; color:var(--txt-weak); }

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

.pill{
  padding:8px 12px; border-radius:999px;
  background: #e8fbfe;
  border:1px solid var(--border);
  font-size:14px; color:var(--txt-weak);
}
.pill b{ color:var(--accent); }

/* é¡Œç›®å¡ç‰‡ */
.question{
  font-size:clamp(28px,6vw,44px);
  text-align:center; padding:16px; border-radius:16px;
  background: var(--card);
  border:1px solid var(--border);
  letter-spacing:1px;
  color: var(--txt);
}

/* é¸é …å€ï¼ˆç¶­æŒ 2 æ¬„ï¼‰ */
.options{
  display:grid; grid-template-columns:repeat(2,1fr); gap:10px;
  margin-bottom:6px; /* é¿å…è¢«ä¸Šæ–¹ sticky æ“‹åˆ° */
}

button.option{
  padding:14px 10px; font-size:clamp(18px,3.5vw,22px);
  border-radius:14px;
  border:1px solid var(--border);
  background: var(--card-2);
  color: var(--txt-weak);
  cursor:pointer;
  transition:.15s transform,.15s background,.15s border;
}
button.option:hover{ transform:translateY(-1px); background: var(--card-3); }
button.option.correct{ border-color:rgba(34,197,94,.7); background:rgba(34,197,94,.15); color:#0b3d1d; }
button.option.wrong{ border-color:rgba(239,68,68,.7); background:rgba(239,68,68,.12); color:#7a1e1e; }

/* æ§åˆ¶æŒ‰éˆ• */
.controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
.btn{
  padding:10px 14px; border-radius:12px;
  border:1px solid var(--border);
  background: #d8f4f8;
  color: var(--txt);
  cursor:pointer; font-size:16px;
  transition: .15s background, .15s transform;
}
.btn:hover{ background:#cdeff4; transform:translateY(-1px); }

.btn.primary{ border-color: var(--accent); background: rgba(0,188,212,.12); color:#015a63; }
.btn.danger{ border-color: var(--bad); background: rgba(239,68,68,.12); color:#7a1e1e; }
.btn.success{ border-color: var(--good); background: rgba(34,197,94,.12); color:#0b3d1d; }

/* æç¤ºå€ */
.tip{
  font-size:14px;
  border-left:3px solid var(--accent);
  padding:10px 12px;
  background:#e8fbfe;
  border-radius:8px;
  color:var(--txt-weak);
  opacity:.95;
}

.scoreboard{ display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap; }
.muted{ opacity:.7; }
footer{ opacity:.7; font-size:12px; text-align:center; color:var(--txt-weak); }

.grid{ display:grid; gap:10px; }
.grid.cols-3{ grid-template-columns:repeat(3,1fr); }

label{ font-size:14px; opacity:.95; color:var(--txt-weak); }
select{
  width:100%; padding:10px 12px; border-radius:10px;
  border:1px solid var(--border);
  background:#e8fbfe;
  color:var(--txt);
}

/* ========== å›é¡§å€å¡Š ========== */
#review{ display:none; }
.review-title{ font-size:20px; margin:0 0 8px; color:var(--txt); }
.review-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 12px; }
.review-list{ display:grid; gap:10px; max-height:360px; overflow:auto; padding-right:6px; }
.review-item{
  border:1px solid var(--border);
  border-radius:12px; padding:12px;
  background: var(--card-2);
  color: var(--txt-weak);
}
.review-item .q{ font-size:18px; margin-bottom:6px; color:var(--txt); }
.review-item .you{ color:var(--bad); }
.review-item .ans{ color:var(--good); }
.review-item .how{ font-size:14px; opacity:.9; color:var(--txt-weak); }
.empty{ opacity:.8; padding:8px 0; color:var(--txt-weak); }

a{ color:#00838f; text-decoration:none; }

/* === Mobile-friendly åŸºç¤å¼·åŒ–ï¼šå…¨åŸŸè§¸æ§é«”é©— === */
button, .btn, .option, select{
  min-height:var(--tap-min);
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
button:focus-visible, .btn:focus-visible, .option:focus-visible, select:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:2px;
  border-radius:14px;
}

/* è¡Œç‚ºï¼šæ‰‹æ©Ÿæ²’æœ‰ hoverï¼Œç”¨ active/pressed çµ¦å›é¥‹ */
@media (hover:none){
  button.option:hover{ transform:none; background: var(--card-2); }
  button.option:active{ transform:scale(0.98); background: var(--card-3); }
}

/* === å°å°ºå¯¸æ–·é»ï¼šâ‰¤ 480px === */
@media (max-width:480px){
  body{ padding:max(12px, env(safe-area-inset-left)); }
  .wrap{ gap:12px; }

  .card{ padding:16px; border-radius:18px; }

  .grid.cols-3{ grid-template-columns:1fr; gap:12px; }
  label{ font-size:15px; }
  select{
    font-size:16px; /* iOS 16px é¿å…è‡ªå‹•æ”¾å¤§ */
    padding:14px 12px; border-radius:12px;
  }

  .row{ gap:8px; }
  .pill{
    font-size:15px; padding:8px 12px;
    line-height:1.3; white-space:normal;
  }

  .options{
    grid-template-columns:repeat(2,1fr); gap:10px;
  }

  button.option{
    font-size:18px; padding:16px 14px; border-radius:16px;
  }

  .controls{ gap:12px; }
  .controls .btn{
    flex:1 1 auto;
    font-size:17px;
    padding:14px 16px;
    border-radius:14px;
  }

  .tip{ font-size:15px; padding:12px; }

  .review-title{ font-size:18px; }
  .review-list{ max-height:50vh; }
  .review-item{ padding:12px; }
  .review-item .q{ font-size:16px; }
  .review-item .how{ font-size:14px; }
}

/* === ä¸­å°å°ºå¯¸ï¼ˆâ‰¤ 768pxï¼‰=== */
@media (max-width:768px){
  /* å¦‚æœä½ æƒ³è®“å¹³æ¿ä»ä¿æŒå…©æ¬„ï¼Œå¯ä»¥è¨»è§£ä¸‹ä¸€è¡Œ */
  .options{ grid-template-columns:1fr; }
  .controls .btn{ min-width:44%; }
}

/* === è®“æ§åˆ¶å€åœ¨é•·é é¢æ™‚æ›´æ˜“è§¸é”ï¼ˆæ˜äº®ç‰ˆï¼‰ === */
@media (max-width:768px){
  .scoreboard{
    position:sticky; top:8px; z-index:5;
    background: linear-gradient(180deg, rgba(224,247,250,.95), rgba(224,247,250,.85));
    border-radius:14px; padding:8px;
    backdrop-filter: blur(6px);
    border:1px solid var(--border);
  }
}

  </style>
</head>

<body>
  <main class="wrap">
    <!-- ========== 1) æ§åˆ¶åˆ— ========== -->
    <section class="card">
      <h1 style="color:#black;">ğŸ® 100 ä»¥å…§å…©ä½æ•¸ä¹˜æ³•é€Ÿç®—ï½œç·´ç¿’ & æ¸¬é©—</h1>
      <div class="sub" style="color:#grey;">
        <b>ç·´ç¿’æ¨¡å¼ï¼š</b>ä¸è¨ˆåˆ†ï¼Œåªç·´ç¿’é¡Œå‹èˆ‡è§£æ³•æç¤ºã€‚<br />
        <b>æ¸¬é©—æ¨¡å¼ï¼ˆç™¾åˆ†åˆ¶ï¼‰ï¼š</b>æ»¿åˆ† 100ï¼›5 é¡ŒÃ—20 åˆ†ã€10 é¡ŒÃ—10 åˆ†ã€20 é¡ŒÃ—5 åˆ†ã€50 é¡ŒÃ—2 åˆ†ï¼›çµæŸå¾Œæä¾›éŒ¯é¡Œå›é¡§èˆ‡ CSV åŒ¯å‡ºã€‚<br />
        ğŸ’» ç¨‹å¼è¨­è¨ˆï¼š<a href="https://drwu.carrd.co" target="_blank">ä»¨å¯¶çˆ¸ä¸­é†«åšå£«å³å•“éŠ˜</a>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="modeSelect">æ¨¡å¼</label>
          <select id="modeSelect">
            <option value="practice">ç·´ç¿’æ¨¡å¼ï¼ˆä¸è¨ˆåˆ†ï¼‰</option>
            <option value="exam">æ¸¬é©—æ¨¡å¼ï¼ˆæ»¿åˆ† 100ï¼‰</option>
          </select>
        </div>

        <div>
          <label for="typeSelect">é¡Œå‹ï¼ˆç·´ç¿’å¯æŒ‡å®šï¼Œæ¸¬é©—å¯é¸æ··åˆæˆ–æŒ‡å®šï¼‰</label>
          <select id="typeSelect">
            <option value="æ··åˆ">æ··åˆ</option>
            <option value="æ‹†åˆ†">æ‹†åˆ†</option>
            <option value="å¹³æ–¹å·®">å¹³æ–¹å·®</option>
            <option value="æ¥è¿‘100">æ¥è¿‘100</option>
            <option value="å°¾æ•¸äº’è£œ">å°¾æ•¸äº’è£œ</option>
            <option value="å°¾æ•¸5å¹³æ–¹">å°¾æ•¸5å¹³æ–¹</option>
            <option value="å€æ•¸/ä¸€åŠ">å€æ•¸/ä¸€åŠ</option>
            <option value="å¹³æ–¹">å¹³æ–¹</option>
          </select>
        </div>

        <div>
          <label for="examCount">æ¸¬é©—é¡Œæ•¸ï¼ˆåƒ…æ¸¬é©—æ¨¡å¼ï¼‰</label>
          <select id="examCount">
            <option value="5">5 é¡Œï¼ˆæ¯é¡Œ 20 åˆ†ï¼‰</option>
            <option value="10" selected>10 é¡Œï¼ˆæ¯é¡Œ 10 åˆ†ï¼‰</option>
            <option value="20">20 é¡Œï¼ˆæ¯é¡Œ 5 åˆ†ï¼‰</option>
            <option value="50">50 é¡Œï¼ˆæ¯é¡Œ 2 åˆ†ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="scoreboard" style="margin-top:12px">
        <div class="row">
          <div class="pill">ç›®å‰æ¨¡å¼ï¼š<b id="modeLabel">ç·´ç¿’</b></div>
          <div class="pill">é¡Œå‹ï¼š<b id="typeLabel">æ··åˆ</b></div>
          <div class="pill">ç›®å‰åˆ†æ•¸ï¼š<b id="score">â€”</b></div>
          <div class="pill">é€²åº¦ï¼š<b id="progress">â€”</b></div>
          <div class="pill">æ¯é¡Œé…åˆ†ï¼ˆæ¸¬é©—ï¼‰ï¼š<b id="perQ">â€”</b></div>
          <div class="pill">é€£çºŒç­”å°ï¼š<b id="streak">0</b></div>
        </div>

        <div class="row controls">
          <button class="btn primary" id="btnStart">é–‹å§‹</button>
          <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ</button>
          <button class="btn danger" id="btnReset">é‡ç½®</button>
        </div>
      </div>
    </section>

    <!-- ========== 2) å‡ºé¡Œå€ ========== -->
    <section class="card" id="play">
      <div id="question" class="question">è«‹é¸æ“‡æ¨¡å¼èˆ‡é¡Œå‹å¾ŒæŒ‰ã€Œé–‹å§‹ã€ã€‚</div>
      <div id="options" class="options"></div>
    </section>

    <!-- ========== 3) æç¤ºå€ ========== -->
    <section class="card">
      <div class="tip" id="tip">
        æç¤ºæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼ˆç­”éŒ¯æˆ–æŒ‰ä¸‹ä¸€é¡Œå¾Œå‡ºç¾ï¼‰ã€‚<br />
        <span class="muted">å€æ•¸/ä¸€åŠæœƒä¾æƒ…æ³çµ¦ï¼šå°åŠÃ—åŠ å€ã€25/50 æ³•ï¼ˆå¯æ•´é™¤æ™‚ï¼‰ã€æˆ–ã€Œå…ˆæå…¬å› æ•¸ã€ã€‚</span>
      </div>
    </section>

    <!-- ========== 4) éŒ¯é¡Œå›é¡§ï¼ˆæ¸¬é©—çµæŸæ‰é¡¯ç¤ºï¼‰ ========== -->
    <section class="card" id="review">
      <div class="review-head">
        <h3 class="review-title">ğŸ“ éŒ¯é¡Œå›é¡§ï¼ˆå«è§£æ³•èˆ‡æ­£ç¢ºç­”æ¡ˆï¼‰</h3>
        <div class="review-actions">
          <button class="btn success" id="btnExport">åŒ¯å‡ºéŒ¯é¡Œ CSV</button>
        </div>
      </div>
      <div id="reviewList" class="review-list"></div>
      <div class="empty" id="reviewEmpty">å¤ªå¼·äº†ï¼é€™æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯é¡Œã€‚</div>
    </section>

    <footer>
      ç·´ç¿’æ¨¡å¼ï¼š<b>ä¸è¨ˆåˆ†</b>
      ï½œ æ¸¬é©—æ¨¡å¼ï¼š<b>æ»¿åˆ† 100</b>ï¼ˆ5/10/20/50 é¡Œå°æ‡‰æ¯é¡Œ 20/10/5/2 åˆ†ï¼›ç­”å°æ‰åŠ åˆ†ï¼‰ã€‚
    </footer>
  </main>

  <script>
    /* =========================================
       ç‹€æ…‹èˆ‡ DOM
       ========================================= */
    let mode = 'practice';         // 'practice' | 'exam'
    let targetType = 'æ··åˆ';
    let examTotal = 10;            // é è¨­ 10 é¡Œ
    let counter = 0;               // å·²ä½œç­”é¡Œæ•¸ï¼ˆæ¸¬é©—ï¼‰
    let score = 0;                 // æ¸¬é©—åˆ†æ•¸ï¼›ç·´ç¿’æ¨¡å¼é¡¯ç¤ºç‚ºã€Œâ€”ã€
    let streak = 0;                // é€£çºŒç­”å°æ•¸
    let current = null;            // ç•¶å‰é¡Œç›® {a,b,ans,tip,type}
    let locked = false;            // é˜²é‡è¤‡é»æ“Š
    let wrongLog = [];             // æ¸¬é©—éŒ¯é¡Œå›é¡§ [{q,type,your,ans,tip}]

    // DOM å¿«å–
    const modeSelect  = document.getElementById('modeSelect');
    const typeSelect  = document.getElementById('typeSelect');
    const examCount   = document.getElementById('examCount');
    const modeLabel   = document.getElementById('modeLabel');
    const typeLabel   = document.getElementById('typeLabel');
    const scoreEl     = document.getElementById('score');
    const progressEl  = document.getElementById('progress');
    const perQEl      = document.getElementById('perQ');
    const streakEl    = document.getElementById('streak');
    const qEl         = document.getElementById('question');
    const optsEl      = document.getElementById('options');
    const tipEl       = document.getElementById('tip');
    const reviewSec   = document.getElementById('review');
    const reviewList  = document.getElementById('reviewList');
    const reviewEmpty = document.getElementById('reviewEmpty');
    const btnStart    = document.getElementById('btnStart');
    const btnNext     = document.getElementById('btnNext');
    const btnReset    = document.getElementById('btnReset');
    const btnExport   = document.getElementById('btnExport');

    /* =========================================
       äº‹ä»¶è¨»å†Š
       ========================================= */
    modeSelect.addEventListener('change', () => {
      mode = modeSelect.value;
      modeLabel.textContent = (mode === 'practice' ? 'ç·´ç¿’' : 'æ¸¬é©—');
      updatePerQ();
      updateProgress();
      renderScore();
    });

    typeSelect.addEventListener('change', () => {
      targetType = typeSelect.value;
      typeLabel.textContent = targetType;
    });

    examCount.addEventListener('change', () => {
      examTotal = Number(examCount.value);
      updatePerQ();
      updateProgress();
    });

    btnStart.addEventListener('click', start);
    btnNext.addEventListener('click', () => { if (!locked) newQuestion(); });
    btnReset.addEventListener('click', resetAll);
    btnExport.addEventListener('click', exportWrongCSV);

    /* =========================================
       ä¸»æµç¨‹æ§åˆ¶
       ========================================= */
    function start() {
      score = 0;
      streak = 0;
      counter = 0;
      wrongLog = [];
      reviewSec.style.display = 'none';
      updatePerQ();
      updateUI();
      newQuestion();
    }

    function resetAll() {
      score = 0;
      streak = 0;
      counter = 0;
      wrongLog = [];
      updateUI();
      qEl.textContent = 'è«‹é¸æ“‡æ¨¡å¼èˆ‡é¡Œå‹å¾ŒæŒ‰ã€Œé–‹å§‹ã€ã€‚';
      optsEl.innerHTML = '';
      tipEl.innerHTML = 'æç¤ºæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼ˆç­”éŒ¯æˆ–æŒ‰ä¸‹ä¸€é¡Œå¾Œå‡ºç¾ï¼‰ã€‚<br><span class="muted">å€æ•¸/ä¸€åŠæœƒä¾æƒ…æ³çµ¦ï¼šå°åŠÃ—åŠ å€ã€25/50 æ³•ï¼ˆå¯æ•´é™¤æ™‚ï¼‰ã€æˆ–ã€Œå…ˆæå…¬å› æ•¸ã€ã€‚</span>';
      reviewSec.style.display = 'none';
    }

    /* =========================================
       UI æ›´æ–°è¼”åŠ©
       ========================================= */
    function updateUI() {
      modeLabel.textContent = (mode === 'practice' ? 'ç·´ç¿’' : 'æ¸¬é©—');
      typeLabel.textContent = targetType;
      updateProgress();
      renderScore();
      streakEl.textContent = String(streak);
    }

    function updateProgress() {
      if (mode === 'exam') {
        progressEl.textContent = `${counter}/${examTotal}`;
      } else {
        progressEl.textContent = 'â€”';
      }
    }

    function updatePerQ() {
      if (mode === 'exam') {
        const perQ = perScoreFor(examTotal);
        perQEl.textContent = `${perQ} åˆ†ï¼é¡Œï¼ˆæ»¿åˆ† 100ï¼‰`;
      } else {
        perQEl.textContent = 'â€”';
      }
    }

    function renderScore() {
      scoreEl.textContent = (mode === 'exam') ? String(Math.round(score)) : 'â€”';
    }

    // æ¯é¡Œé…åˆ†ï¼ˆå›ºå®š 5/10/20/50 é¡Œï¼‰
    function perScoreFor(n) {
      if (n === 5)  return 20;
      if (n === 10) return 10;
      if (n === 20) return 5;
      if (n === 50) return 2;
      // å¾Œå‚™ï¼šä»»æ„é¡Œæ•¸ä»å°é½Š 100 åˆ†åˆ¶
      return +(100 / n).toFixed(2);
    }

    /* =========================================
       å‡ºé¡Œæµç¨‹
       ========================================= */
    function newQuestion() {
      locked = false;
      // æ··åˆï¼šæŠ½æ¬Šé‡ï¼›ç·´ç¿’å¯æŒ‡å®š
      const type = (mode === 'practice' && targetType !== 'æ··åˆ')
        ? targetType
        : (targetType === 'æ··åˆ' ? weightedPick() : targetType);

      current = generateByType(type);

      qEl.textContent = `${current.a} Ã— ${current.b} = ?ã€€ï¼ˆ${current.type}ï¼‰`;
      tipEl.textContent = 'æç¤ºï¼šå…ˆè‡ªå·±è©¦è©¦çœ‹ï¼Œç­”éŒ¯æœƒé¡¯ç¤ºè§£æ³•ã€‚';

      renderOptions();
      updateProgress();
    }

    // æ··åˆæ™‚çš„é¡Œå‹æ¬Šé‡ï¼ˆé¿å…å¹¾ä¹éƒ½è½åœ¨æ‹†åˆ†ï¼‰
    function weightedPick() {
      const bag = [
        'å¹³æ–¹å·®','å¹³æ–¹å·®','å¹³æ–¹å·®',
        'æ¥è¿‘100','æ¥è¿‘100',
        'å°¾æ•¸äº’è£œ','å°¾æ•¸äº’è£œ',
        'å°¾æ•¸5å¹³æ–¹',
        'å€æ•¸/ä¸€åŠ',
        'å¹³æ–¹',
        'æ‹†åˆ†','æ‹†åˆ†'
      ];
      return bag[Math.floor(Math.random() * bag.length)];
    }

    // é¡Œç›®ç”Ÿæˆï¼ˆä¾é¡Œå‹ï¼‰
    function generateByType(type) {
      let a, b, tries = 0;

      while (tries < 500) {
        tries++;
        a = randInt(10, 99);
        b = randInt(10, 99);

        if (type === 'å°¾æ•¸5å¹³æ–¹') {
          a = randPick([15,25,35,45,55,65,75,85,95]);
          b = a;
        } else if (type === 'å¹³æ–¹') {
          a = randInt(10, 99);
          b = a;
        } else if (type === 'æ¥è¿‘100') {
          a = randInt(90, 99);
          b = randInt(90, 99);
        } else if (type === 'å°¾æ•¸äº’è£œ') {
          const t = randInt(1, 9);
          const u = randPick([1,2,3,4,5,6,7,8,9]);
          const v = 10 - u;
          a = t * 10 + u;
          b = t * 10 + v;
        } else if (type === 'å¹³æ–¹å·®') {
          const m = randPick([20,30,40,50,60,70,80,90]);
          const n = randPick([1,2,3,4]);
          a = m - n;
          b = m + n;
        } else if (type === 'å€æ•¸/ä¸€åŠ') {
          if (Math.random() < 0.4) {
            a = randPick([25, 50]);
            b = randInt(10, 99);
          } else {
            const pool = [12,14,15,16,18,20,24,28,30,32,36,40,42,44,48];
            a = randPick(pool);
            b = randPick(pool);
          }
        }

        // é©—è­‰æ˜¯å¦ç¬¦åˆè©²é¡Œå‹è¦å‰‡ï¼ˆå¦å‰‡é‡æŠ½ï¼‰
        if (validateType(type, a, b)) {
          const ans = a * b;
          const { tip, type: finalType } = decideTip(a, b);
          return { a, b, ans, tip, type: finalType };
        }
      }

      // ç†è«–ä¸Šä¸æœƒåˆ°é€™è£¡ï¼›ä¿åº•å›å‚³
      const ans = a * b;
      const { tip, type: finalType } = decideTip(a, b);
      return { a, b, ans, tip, type: finalType };
    }

    // ä¾é¡Œå‹æª¢æ ¸æ˜¯å¦åˆæ ¼
    function validateType(type, a, b) {
      if (type === 'å°¾æ•¸5å¹³æ–¹') return (a === b && a % 10 === 5);
      if (type === 'å¹³æ–¹')     return (a === b);
      if (type === 'æ¥è¿‘100')  return (a >= 90 && b >= 90);
      if (type === 'å°¾æ•¸äº’è£œ') return (Math.floor(a/10) === Math.floor(b/10) && ((a % 10) + (b % 10) === 10));
      if (type === 'å¹³æ–¹å·®') {
        const d = Math.abs(a - b);
        return ((a + b) % 2 === 0) && (d % 2 === 0) && d >= 2 && d <= 8;
      }
      if (type === 'å€æ•¸/ä¸€åŠ') {
        return (
          (a % 2 === 0 && b % 2 === 0) ||
          (a % 25 === 0 || b % 25 === 0 || a % 50 === 0 || b % 50 === 0) ||
          gcd(a, b) > 1
        );
      }
      return true;
    }

    /* =========================================
       å°å·¥å…·ï¼šäº‚æ•¸ã€å…¬å› æ•¸
       ========================================= */
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function randPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function gcd(x, y) { while (y) { [x, y] = [y, x % y]; } return x; }

    /* =========================================
       å¿ƒç®—è·¯å¾‘ï¼šå°åŠÃ—åŠ å€ï¼ˆæ­¥é©Ÿè¨˜éŒ„ï¼‰
       ========================================= */
    function halfDoubleSteps(a, b) {
      let x = a, y = b;
      const states = [`${x}Ã—${y}`];
      let moves = 0;

      // æ¢ä»¶ï¼šå…©æ•¸çš†ç‚ºå¶æ•¸ï¼Œx > 1ï¼Œé™åˆ¶æœ€å¤š 4 æ­¥ï¼Œé¿å…å¤ªé•·
      while (x % 2 === 0 && y % 2 === 0 && x > 1 && moves < 4) {
        x = x / 2;
        y = y * 2;
        moves++;
        states.push(`${x}Ã—${y}`);

        // è‹¥é‡æ•´å/æ•´ç™¾ï¼Œææ—©çµæŸï¼ˆæ–¹ä¾¿å¿ƒç®—æ”¶å°¾ï¼‰
        if (x % 10 === 0 || y % 10 === 0 || x % 100 === 0 || y % 100 === 0) break;
      }
      return { text: states.join(' â†’ '), lastX: x, lastY: y };
    }

    /* =========================================
       è§£æ³•åˆ¤æ–·ï¼šä¾ aÃ—b è‡ªå‹•æŒ‘æœ€é †æ‰‹æŠ€å·§
       è¦å‰‡å¼·åº¦ï¼š
       1) å°¾æ•¸5å¹³æ–¹ / å¹³æ–¹
       2) å°¾æ•¸äº’è£œï¼ˆåŒåä½ã€å€‹ä½å’Œç‚º10ï¼‰
       3) æ¥è¿‘100
       4) å¹³æ–¹å·®ï¼ˆmâˆ’n, m+nï¼‰
       5) å€æ•¸/ä¸€åŠï¼ˆæ•´ç™¾æ³• â†’ å°åŠÃ—åŠ å€ â†’ æå…¬å› æ•¸ï¼‰
       6) é€€å›æ‹†åˆ†æ³•
       ========================================= */
    function decideTip(a, b) {
      const ans = a * b;
      const same = (a === b);
      const tensA = Math.floor(a / 10), tensB = Math.floor(b / 10);
      const onesA = a % 10, onesB = b % 10;

      // 1) å°¾æ•¸5å¹³æ–¹
      if (same && a % 10 === 5) {
        const head = Math.floor(a / 10);           // åä½
        const front = head * (head + 1);           // å‰åŠï¼št Ã— (t+1)
        return {
          tip: `ã€å°¾æ•¸5å¹³æ–¹ã€‘å‰ï¼š${head}Ã—(${head}+1)=${front}ï¼›å¾Œï¼š25 â†’ ${front}25 = ${ans}`,
          type: 'å°¾æ•¸5å¹³æ–¹'
        };
      }

      // 2) ä¸€èˆ¬å¹³æ–¹ï¼ˆå°±è¿‘æ•´åå±•é–‹ï¼‰
      if (same) {
        const t = Math.round(a / 10) * 10;         // å°±è¿‘æ•´åï¼š34â†’30ï¼›67â†’70
        const d = Math.abs(a - t);
        const p1 = t * t, p2 = 2 * t * d, p3 = d * d;
        if (a >= t) {
          return {
            tip: `ã€å¹³æ–¹ã€‘(${t}+${d})Â² = ${t}Â² + 2Ã—${t}Ã—${d} + ${d}Â² = ${p1} + ${p2} + ${p3} = ${ans}`,
            type: 'å¹³æ–¹'
          };
        } else {
          return {
            tip: `ã€å¹³æ–¹ã€‘(${t}âˆ’${d})Â² = ${t}Â² âˆ’ 2Ã—${t}Ã—${d} + ${d}Â² = ${p1} âˆ’ ${p2} + ${p3} = ${ans}`,
            type: 'å¹³æ–¹'
          };
        }
      }

      // 3) å°¾æ•¸äº’è£œï¼ˆåŒåä½ã€å€‹ä½å’Œç‚º10ï¼‰
      if (tensA === tensB && (onesA + onesB === 10)) {
        const t = tensA;
        const front = t * (t + 1);                 // å‰åŠï¼šåä½ t Ã— (t+1)
        const back  = onesA * onesB;               // å¾ŒåŠï¼šå€‹ä½ç›¸ä¹˜
        const back2 = back.toString().padStart(2, '0');
        return {
          tip: `ã€å°¾æ•¸äº’è£œã€‘å‰ï¼š${t}Ã—(${t}+1)=${front}ï¼›å¾Œï¼š${onesA}Ã—${onesB}=${back}ï¼ˆè£œå…©ä½ ${back2}ï¼‰â†’ ${front}${back2} = ${ans}`,
          type: 'å°¾æ•¸äº’è£œ'
        };
      }

      // 4) æ¥è¿‘100ï¼ˆNikhilamï¼‰
      if (a >= 90 && b >= 90) {
        const da = 100 - a, db = 100 - b;          // èˆ‡100çš„å·®
        const front = 100 - (da + db);             // å‰åŠï¼š100 âˆ’ (å·®å’Œ)
        const back  = da * db;                     // å¾ŒåŠï¼šå·®çš„ä¹˜ç©
        const back2 = back.toString().padStart(2, '0');
        return {
          tip: `ã€æ¥è¿‘100ã€‘å‰ï¼š100âˆ’(${da}+${db})=${front}ï¼›å¾Œï¼š${da}Ã—${db}=${back}ï¼ˆè£œå…©ä½ ${back2}ï¼‰â†’ ${front}${back2} = ${ans}`,
          type: 'æ¥è¿‘100'
        };
      }

      // 5) å¹³æ–¹å·®ï¼ˆ(mâˆ’n)(m+n)=mÂ²âˆ’nÂ²ï¼‰
      // æ’é™¤ 20/25/50ï¼ˆé€™äº›èµ°æ•´ç™¾æ³•ï¼Œä¸èµ°å¹³æ–¹å·®ï¼‰
      {
        const d = Math.abs(a - b);
        const blocked = (a === 20 || b === 20 || a === 25 || b === 25 || a === 50 || b === 50);
        if (!blocked && ((a + b) % 2 === 0) && (d % 2 === 0) && d >= 2 && d <= 8) {
          const m = (a + b) / 2;
          const n = d / 2;
          const m2 = m * m, n2 = n * n;
          return {
            tip: `ã€å¹³æ–¹å·®ã€‘(${m}âˆ’${n})(${m}+${n}) = ${m}Â² âˆ’ ${n}Â² = ${m2} âˆ’ ${n2} = ${ans}`,
            type: 'å¹³æ–¹å·®'
          };
        }
      }

      // 6) å€æ•¸/ä¸€åŠï¼ˆæ•´ç™¾æ³• â†’ å°åŠÃ—åŠ å€ â†’ æå…¬å› æ•¸ï¼‰
      const g = gcd(a, b);

      // 6-1) ç‰¹æ®Šæ•´ç™¾ï¼š20/25/50
      if (a === 20 && b % 5 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘20=100Ã·5 â†’ ${a}Ã—${b} = 100Ã—${b/5} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (b === 20 && a % 5 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘20=100Ã·5 â†’ ${a}Ã—${b} = 100Ã—${a/5} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (a === 25 && b % 4 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘25=100Ã·4 â†’ ${a}Ã—${b} = 100Ã—${b/4} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (b === 25 && a % 4 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘25=100Ã·4 â†’ ${a}Ã—${b} = 100Ã—${a/4} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (a === 50 && b % 2 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘50=100Ã·2 â†’ ${a}Ã—${b} = 100Ã—${b/2} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (b === 50 && a % 2 === 0) {
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘50=100Ã·2 â†’ ${a}Ã—${b} = 100Ã—${a/2} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }

      // 6-2) ä¸€èˆ¬åŒ–æ•´ç™¾ï¼ˆa æˆ– b æ˜¯ 25/50 çš„å€æ•¸ï¼Œä¸”å¦ä¸€é‚Šå¯è¢« 4/2 æ•´é™¤ï¼‰
      if (a % 50 === 0 && b % 2 === 0) {
        const k = a / 50;
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘50=100Ã·2 â†’ ${a}Ã—${b} = 100Ã—(${k}Ã—${b}/2) = 100Ã—${(k*b)/2} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (b % 50 === 0 && a % 2 === 0) {
        const k = b / 50;
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘50=100Ã·2 â†’ ${a}Ã—${b} = 100Ã—(${k}Ã—${a}/2) = 100Ã—${(k*a)/2} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (a % 25 === 0 && b % 4 === 0) {
        const k = a / 25;
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘25=100Ã·4 â†’ ${a}Ã—${b} = 100Ã—(${k}Ã—${b}/4) = 100Ã—${(k*b)/4} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }
      if (b % 25 === 0 && a % 4 === 0) {
        const k = b / 25;
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘25=100Ã·4 â†’ ${a}Ã—${b} = 100Ã—(${k}Ã—${a}/4) = 100Ã—${(k*a)/4} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }

      // 6-3) å…©æ•¸çš†å¶æ•¸ â†’ å°åŠÃ—åŠ å€
      if (a % 2 === 0 && b % 2 === 0) {
        const { text } = halfDoubleSteps(a, b);
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘å°åŠÃ—åŠ å€ï¼š${text} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }

      // 6-4) æœ‰å…¬å› æ•¸ â†’ å…ˆæå…¬å› æ•¸
      if (g > 1) {
        const m = a / g, n = b / g;
        return { tip: `ã€å€æ•¸/ä¸€åŠã€‘å…ˆæå…¬å› æ•¸ï¼š${a}Ã—${b} = (${g}Ã—${m})Ã—(${g}Ã—${n}) = ${g}Â²Ã—(${m}Ã—${n}) = ${g*g}Ã—${m*n} = ${ans}`, type: 'å€æ•¸/ä¸€åŠ' };
      }

      // 7) æ‹†åˆ†æ³• fallbackï¼š (A0+aU)(B0+bU) = å››é …å±•é–‹
      const aT = tensA, aU = onesA, bT = tensB, bU = onesB;
      const p1 = (aT * 10) * (bT * 10);
      const p2 = (aT * 10) * bU;
      const p3 = aU * (bT * 10);
      const p4 = aU * bU;
      return {
        tip: `ã€æ‹†åˆ†ã€‘(${aT}0+${aU})Ã—(${bT}0+${bU}) = ${p1} + ${p2} + ${p3} + ${p4} = ${ans}`,
        type: 'æ‹†åˆ†'
      };
    }

    /* =========================================
       å»ºç«‹é¸é …ï¼ˆæ­£è§£ + å¹²æ“¾ï¼‰
       ========================================= */
    function buildOptions(ans) {
      const s = new Set([ans]);

      // å…ˆæ”¾ä¸€äº›é è¿‘ç­”æ¡ˆçš„å¹²æ“¾å€¼
      while (s.size < 2) s.add(ans + randInt(-25, 25));

      const rounded = Math.round(ans / 10) * 10;
      if (rounded > 0) s.add(rounded);

      if (ans > 99) s.add(ans - (ans % 10 || 10));

      s.add(ans + (10 * (randInt(-2, 2))));

      let arr = Array.from(s).filter(x => x > 0);
      while (arr.length < 4) {
        const w = ans + randInt(-40, 40);
        if (w > 0 && !arr.includes(w)) arr.push(w);
      }
      arr = arr.slice(0, 4);
      return arr.sort(() => Math.random() - 0.5);
    }

    /* =========================================
       å‡ºé¡Œèˆ‡ä½œç­”æµç¨‹
       ========================================= */
    function renderOptions() {
      const ops = buildOptions(current.ans);
      optsEl.innerHTML = '';
      ops.forEach(val => {
        const btn = document.createElement('button');
        btn.className = 'option';
        btn.textContent = String(val);
        btn.addEventListener('click', () => choose(val, btn));
        optsEl.appendChild(btn);
      });
    }

    function choose(val, btn) {
      if (locked) return;
      locked = true;

      const all = Array.from(document.querySelectorAll('button.option'));
      const correctBtn = all.find(b => Number(b.textContent) === current.ans);

      if (val === current.ans) {
        btn.classList.add('correct');
        if (mode === 'exam') {
          const perQ = perScoreFor(examTotal);
          score += perQ; // ç­”å°æ‰åŠ åˆ†
        }
        streak += 1;
        tipEl.innerHTML = `âœ… ç­”å°ï¼${mode==='exam' ? `æœ¬é¡Œ +${perScoreFor(examTotal)} åˆ†ã€€` : ''}<span class="muted">ğŸ”¥ é€£å° ${streak} é¡Œï¼</span>`;
      } else {
        btn.classList.add('wrong');
        if (correctBtn) correctBtn.classList.add('correct');
        streak = 0;
        tipEl.innerHTML = `âŒ ç­”éŒ¯ï¼<br>è§£æ³•ï¼š${current.tip}`;
        if (mode === 'exam') {
          wrongLog.push({
            q: `${current.a} Ã— ${current.b}`,
            type: current.type,
            your: val,
            ans: current.ans,
            tip: current.tip
          });
        }
      }

      renderScore();

      if (mode === 'exam') {
        counter += 1;
        updateProgress();
        setTimeout(() => {
          if (counter >= examTotal) {
            endExam();
          } else {
            newQuestion();
          }
        }, 600);
      } else {
        setTimeout(() => { locked = false; }, 200);
      }
    }

    function endExam() {
      locked = true;
      document.querySelectorAll('button.option').forEach(b => b.disabled = true);
      const finalScore = Math.round(score); // ç™¾åˆ†åˆ¶æ•´æ•¸
      qEl.textContent = `æ¸¬é©—çµæŸï¼ä½ çš„åˆ†æ•¸ï¼š${finalScore} / 100ï¼ˆå…± ${examTotal} é¡Œï¼‰`;
      tipEl.innerHTML = 'ä¸‹æ–¹åˆ—å‡ºæœ¬æ¬¡æ¸¬é©—çš„éŒ¯é¡Œèˆ‡è§£æ³•ï¼Œå¯æŒ‰ã€ŒåŒ¯å‡ºéŒ¯é¡Œ CSVã€ã€‚';
      showReview();
    }

    /* =========================================
       å›é¡§å€
       ========================================= */
    function showReview() {
      reviewSec.style.display = 'block';
      reviewList.innerHTML = '';

      if (wrongLog.length === 0) {
        reviewEmpty.style.display = 'block';
        return;
      }
      reviewEmpty.style.display = 'none';

      wrongLog.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
          <div class="q">#${idx + 1}ã€€${it.q}ã€€<span class="muted">ï¼ˆ${it.type}ï¼‰</span></div>
          <div>ä½ çš„ç­”æ¡ˆï¼š<span class="you">${it.your}</span>ã€€ï½œã€€æ­£ç¢ºï¼š<span class="ans">${it.ans}</span></div>
          <div class="how">è§£æ³•ï¼š${it.tip}</div>
        `;
        reviewList.appendChild(div);
      });

      reviewSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* =========================================
       åŒ¯å‡ºéŒ¯é¡Œ CSV
       ========================================= */
    function exportWrongCSV() {
      if (!wrongLog.length) {
        alert('é€™æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯é¡Œå¯åŒ¯å‡ºã€‚');
        return;
      }
      const header = ['é¡Œç›®','é¡Œå‹','ä½ çš„ç­”æ¡ˆ','æ­£ç¢ºç­”æ¡ˆ','è§£æ³•'];
      const rows = wrongLog.map(r => [r.q, r.type, String(r.your), String(r.ans), r.tip]);

      const csv = [header, ...rows]
        .map(row => row.map(csvEscape).join(','))
        .join('\r\n');

      // åœ¨æª”é ­åŠ ä¸Š BOMï¼Œé¿å… Excel äº‚ç¢¼
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'wrong_questions.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // CSV æ¬„ä½è½‰ç¾©ï¼ˆå«é€—è™Ÿ/é›™å¼•è™Ÿéœ€åŠ å¼•è™Ÿï¼Œä¸¦å°‡å…§éƒ¨ " è½‰ç‚º ""ï¼‰
    function csvEscape(val) {
      const s = (val ?? '').toString().replace(/\r?\n/g, ' ');
      return /[",]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
    }
  </script>
</body>
</html>
