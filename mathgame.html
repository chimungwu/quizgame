<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…©ä½æ•¸ä¹˜æ³•é€Ÿç®—ï½œç·´ç¿’ & æ¸¬é©—ï¼ˆç°¡å–®ç™¾åˆ†åˆ¶ï¼‹CSVåŒ¯å‡ºï¼‰</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --txt:#e5e7eb; --accent:#38bdf8; --good:#22c55e; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#0b1220,#0b1325 40%,#0b152a);
      color:var(--txt); display:flex; min-height:100vh; align-items:center; justify-content:center; padding:20px;
    }
    .wrap{width:min(1000px,100%); display:grid; gap:16px}
    .card{
      background:rgba(17,24,39,.85); border:1px solid #1f2937; border-radius:20px; padding:20px; backdrop-filter:blur(6px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0 0 6px; font-size:clamp(28px,4vw,40px)}
    .sub{opacity:.95; font-size:14px; margin-bottom:12px; line-height:1.6}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{padding:8px 12px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:14px}
    .pill b{color:var(--accent)}
    .question{
      font-size:clamp(28px,6vw,44px); text-align:center; padding:16px; border-radius:16px;
      background:#0b1220; border:1px solid #1f2937; letter-spacing:1px
    }
    .options{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    button.option{
      padding:14px 10px; font-size:clamp(18px,3.5vw,22px); border-radius:14px; border:1px solid #374151;
      background:#0d1726; color:var(--txt); cursor:pointer; transition:.15s transform,.15s background,.15s border;
    }
    button.option:hover{transform:translateY(-1px); background:#0f1c30}
    button.option.correct{border-color:rgba(34,197,94,.7); background:rgba(34,197,94,.1)}
    button.option.wrong{border-color:rgba(239,68,68,.7); background:rgba(239,68,68,.08)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid #374151; background:#0d1726; color:var(--txt);
      cursor:pointer; font-size:16px
    }
    .btn.primary{border-color:var(--accent); background:rgba(56,189,248,.1)}
    .btn.danger{border-color:#ef4444; background:rgba(239,68,68,.1)}
    .btn.success{border-color:#22c55e; background:rgba(34,197,94,.1)}
    .tip{
      font-size:14px; border-left:3px solid var(--accent); padding:10px 12px; background:#0b1220; border-radius:8px; opacity:.95
    }
    .scoreboard{display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap}
    .muted{opacity:.7}
    footer{opacity:.7; font-size:12px; text-align:center}

    .grid{display:grid; gap:10px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:14px; opacity:.95}
    select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--txt)
    }

    /* å›é¡§å€å¡Š */
    #review{display:none}
    .review-title{font-size:20px; margin:0 0 8px}
    .review-actions{display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 12px}
    .review-list{display:grid; gap:10px; max-height:360px; overflow:auto; padding-right:6px}
    .review-item{
      border:1px solid #374151; border-radius:12px; padding:12px; background:#0b1220;
    }
    .review-item .q{font-size:18px; margin-bottom:6px}
    .review-item .you{color:var(--bad)}
    .review-item .ans{color:var(--good)}
    .review-item .how{font-size:14px; opacity:.9}
    .empty{opacity:.8; padding:8px 0}
    a{color:#38bdf8; text-decoration:none}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- 1. æ§åˆ¶åˆ—ï¼ˆé€™è£¡ä¹ŸåŠ ä¸Šä½ çš„ç½²åèˆ‡é€£çµï¼Œé¡è‰²ä¸æœƒã€Œé»‘æ‰ã€ï¼‰ -->
    <section class="card">
      <h1 style="color:#e5e7eb;">ğŸ® 100 ä»¥å…§å…©ä½æ•¸ä¹˜æ³•é€Ÿç®—ï½œç·´ç¿’ & æ¸¬é©—</h1>
      <div class="sub" style="color:#e5e7eb;">
        <b>ç·´ç¿’æ¨¡å¼ï¼š</b>ä¸è¨ˆåˆ†ï¼Œåªç·´ç¿’é¡Œå‹èˆ‡è§£æ³•æç¤ºã€‚<br>
        <b>æ¸¬é©—æ¨¡å¼ï¼ˆç™¾åˆ†åˆ¶ï¼‰ï¼š</b>æ»¿åˆ† 100ï¼›5 é¡ŒÃ—20 åˆ†ã€10 é¡ŒÃ—10 åˆ†ã€20 é¡ŒÃ—5 åˆ†ã€50 é¡ŒÃ—2 åˆ†ï¼›<u>ç­”å°æ‰åŠ åˆ†ï¼Œç­”éŒ¯ä¸æ‰£åˆ†</u>ï¼›çµæŸå¾Œæä¾›éŒ¯é¡Œå›é¡§èˆ‡ CSV åŒ¯å‡ºã€‚<br>
        ğŸ’» ç¨‹å¼è¨­è¨ˆï¼š<a href="https://drwu.carrd.co" target="_blank">ä»¨å¯¶çˆ¸ä¸­é†«åšå£«å³å•“éŠ˜</a>
      </div>

      <div class="grid cols-3">
        <div>
          <label>æ¨¡å¼</label>
          <select id="modeSelect">
            <option value="practice">ç·´ç¿’æ¨¡å¼ï¼ˆä¸è¨ˆåˆ†ï¼‰</option>
            <option value="exam">æ¸¬é©—æ¨¡å¼ï¼ˆæ»¿åˆ† 100ï¼‰</option>
          </select>
        </div>
        <div>
          <label>é¡Œå‹ï¼ˆç·´ç¿’å¯æŒ‡å®šï¼Œæ¸¬é©—å¯é¸æ··åˆæˆ–æŒ‡å®šï¼‰</label>
          <select id="typeSelect">
            <option value="æ··åˆ">æ··åˆ</option>
            <option value="æ‹†åˆ†">æ‹†åˆ†</option>
            <option value="å¹³æ–¹å·®">å¹³æ–¹å·®</option>
            <option value="æ¥è¿‘100">æ¥è¿‘100</option>
            <option value="å°¾æ•¸äº’è£œ">å°¾æ•¸äº’è£œ</option>
            <option value="å°¾æ•¸5å¹³æ–¹">å°¾æ•¸5å¹³æ–¹</option>
            <option value="å€æ•¸/ä¸€åŠ">å€æ•¸/ä¸€åŠ</option>
            <option value="å¹³æ–¹">å¹³æ–¹</option>
          </select>
        </div>
        <div>
          <label>æ¸¬é©—é¡Œæ•¸ï¼ˆåƒ…æ¸¬é©—æ¨¡å¼ï¼‰</label>
          <select id="examCount">
            <option value="5">5 é¡Œï¼ˆæ¯é¡Œ 20 åˆ†ï¼‰</option>
            <option value="10" selected>10 é¡Œï¼ˆæ¯é¡Œ 10 åˆ†ï¼‰</option>
            <option value="20">20 é¡Œï¼ˆæ¯é¡Œ 5 åˆ†ï¼‰</option>
            <option value="50">50 é¡Œï¼ˆæ¯é¡Œ 2 åˆ†ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="scoreboard" style="margin-top:12px">
        <div class="row">
          <div class="pill">ç›®å‰æ¨¡å¼ï¼š<b id="modeLabel">ç·´ç¿’</b></div>
          <div class="pill">é¡Œå‹ï¼š<b id="typeLabel">æ··åˆ</b></div>
          <div class="pill">ç›®å‰åˆ†æ•¸ï¼š<b id="score">â€”</b></div>
          <div class="pill">é€²åº¦ï¼š<b id="progress">â€”</b></div>
          <div class="pill">æ¯é¡Œé…åˆ†ï¼ˆæ¸¬é©—ï¼‰ï¼š<b id="perQ">â€”</b></div>
          <div class="pill">é€£çºŒç­”å°ï¼š<b id="streak">0</b></div>
        </div>
        <div class="row controls">
          <button class="btn primary" id="btnStart">é–‹å§‹</button>
          <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ</button>
          <button class="btn danger" id="btnReset">é‡ç½®</button>
        </div>
      </div>
    </section>

    <!-- 2. å‡ºé¡Œ -->
    <section class="card" id="play">
      <div id="question" class="question">è«‹é¸æ“‡æ¨¡å¼èˆ‡é¡Œå‹å¾ŒæŒ‰ã€Œé–‹å§‹ã€ã€‚</div>
      <div id="options" class="options"></div>
    </section>

    <!-- 3. æç¤º -->
    <section class="card">
      <div class="tip" id="tip">
        æç¤ºæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼ˆç­”éŒ¯æˆ–æŒ‰ä¸‹ä¸€é¡Œå¾Œå‡ºç¾ï¼‰ã€‚<br>
        <span class="muted">å€æ•¸/ä¸€åŠæœƒä¾æƒ…æ³çµ¦ï¼šå°åŠÃ—åŠ å€ã€25/50 æ³•ï¼ˆå¯æ•´é™¤æ™‚ï¼‰ã€æˆ–ã€Œå…ˆæå…¬å› æ•¸ã€ã€‚</span>
      </div>
    </section>

    <!-- 4. éŒ¯é¡Œå›é¡§ï¼ˆæ¸¬é©—çµæŸæ‰é¡¯ç¤ºï¼‰ -->
    <section class="card" id="review">
      <div class="review-head">
        <h3 class="review-title">ğŸ“ éŒ¯é¡Œå›é¡§ï¼ˆå«è§£æ³•èˆ‡æ­£ç¢ºç­”æ¡ˆï¼‰</h3>
        <div class="review-actions">
          <button class="btn success" id="btnExport">åŒ¯å‡ºéŒ¯é¡Œ CSV</button>
        </div>
      </div>
      <div id="reviewList" class="review-list"></div>
      <div class="empty" id="reviewEmpty">å¤ªå¼·äº†ï¼é€™æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯é¡Œã€‚</div>
    </section>

    <footer>
      ç·´ç¿’æ¨¡å¼ï¼š<b>ä¸è¨ˆåˆ†</b> ï½œ æ¸¬é©—æ¨¡å¼ï¼š<b>æ»¿åˆ† 100</b>ï¼ˆ5/10/20/50 é¡Œå°æ‡‰æ¯é¡Œ 20/10/5/2 åˆ†ï¼›ç­”å°æ‰åŠ åˆ†ï¼‰ã€‚
    </footer>
  </main>

  <script>
    // ç‹€æ…‹
    let mode = 'practice';                 // 'practice' | 'exam'
    let targetType = 'æ··åˆ';
    let examTotal = 10;                    // é è¨­ 10 é¡Œ
    let counter = 0;                       // å·²ä½œç­”é¡Œæ•¸ï¼ˆæ¸¬é©—ï¼‰
    let score = 0;                         // æ¸¬é©—åˆ†æ•¸ï¼›ç·´ç¿’æ¨¡å¼é¡¯ç¤ºç‚ºã€Œâ€”ã€
    let streak = 0;
    let current = null;                    // {a,b,ans,tip,type}
    let locked = false;                    // é˜²é‡è¤‡é»æ“Š
    let wrongLog = [];                     // æ¸¬é©—éŒ¯é¡Œå›é¡§ [{q, type, your, ans, tip}]

    // DOM
    const modeSelect = document.getElementById('modeSelect');
    const typeSelect = document.getElementById('typeSelect');
    const examCount = document.getElementById('examCount');
    const modeLabel = document.getElementById('modeLabel');
    const typeLabel = document.getElementById('typeLabel');
    const scoreEl = document.getElementById('score');
    const progressEl = document.getElementById('progress');
    const perQEl = document.getElementById('perQ');
    const streakEl = document.getElementById('streak');
    const qEl = document.getElementById('question');
    const optsEl = document.getElementById('options');
    const tipEl = document.getElementById('tip');
    const reviewSec = document.getElementById('review');
    const reviewList = document.getElementById('reviewList');
    const reviewEmpty = document.getElementById('reviewEmpty');
    const btnStart = document.getElementById('btnStart');
    const btnNext  = document.getElementById('btnNext');
    const btnReset = document.getElementById('btnReset');
    const btnExport = document.getElementById('btnExport');

    // äº‹ä»¶
    modeSelect.addEventListener('change', () => {
      mode = modeSelect.value;
      modeLabel.textContent = (mode==='practice'?'ç·´ç¿’':'æ¸¬é©—');
      updatePerQ();
      updateProgress();
      renderScore();
    });
    typeSelect.addEventListener('change', () => {
      targetType = typeSelect.value;
      typeLabel.textContent = targetType;
    });
    examCount.addEventListener('change', () => {
      examTotal = Number(examCount.value);
      updatePerQ();
      updateProgress();
    });
    btnStart.addEventListener('click', start);
    btnNext.addEventListener('click', () => { if(!locked) newQuestion(); });
    btnReset.addEventListener('click', resetAll);
    btnExport.addEventListener('click', exportWrongCSV);

    // ä¸»æµç¨‹
    function start(){
      score = 0; streak = 0; counter = 0; wrongLog = [];
      reviewSec.style.display = 'none';
      updatePerQ();
      updateUI();
      newQuestion();
    }

    function resetAll(){
      score=0; streak=0; counter=0; wrongLog=[];
      updateUI();
      qEl.textContent = 'è«‹é¸æ“‡æ¨¡å¼èˆ‡é¡Œå‹å¾ŒæŒ‰ã€Œé–‹å§‹ã€ã€‚';
      optsEl.innerHTML = '';
      tipEl.innerHTML = 'æç¤ºæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼ˆç­”éŒ¯æˆ–æŒ‰ä¸‹ä¸€é¡Œå¾Œå‡ºç¾ï¼‰ã€‚<br><span class="muted">å€æ•¸/ä¸€åŠæœƒä¾æƒ…æ³çµ¦ï¼šå°åŠÃ—åŠ å€ã€25/50 æ³•ï¼ˆå¯æ•´é™¤æ™‚ï¼‰ã€æˆ–ã€Œå…ˆæå…¬å› æ•¸ã€ã€‚</span>';
      reviewSec.style.display = 'none';
    }

    // UI æ›´æ–°
    function updateUI(){
      modeLabel.textContent = (mode==='practice'?'ç·´ç¿’':'æ¸¬é©—');
      typeLabel.textContent = targetType;
      updateProgress();
      renderScore();
      streakEl.textContent = streak;
    }
    function updateProgress(){
      if(mode==='exam'){
        progressEl.textContent = `${counter}/${examTotal}`;
      }else{
        progressEl.textContent = 'â€”';
      }
    }
    function updatePerQ(){
      if(mode==='exam'){
        const perQ = perScoreFor(examTotal);
        perQEl.textContent = `${perQ} åˆ†ï¼é¡Œï¼ˆæ»¿åˆ† 100ï¼‰`;
      }else{
        perQEl.textContent = 'â€”';
      }
    }
    function renderScore(){
      scoreEl.textContent = (mode==='exam') ? Math.round(score) : 'â€”';
    }

    // æ¯é¡Œé…åˆ†ï¼ˆå›ºå®š 5/10/20/50 é¡Œï¼‰
    function perScoreFor(n){
      if(n===5) return 20;
      if(n===10) return 10;
      if(n===20) return 5;
      if(n===50) return 2;
      return +(100/n).toFixed(2);
    }

    // å‡ºé¡Œæµç¨‹
    function newQuestion(){
      locked = false;
      const type = (mode==='practice' && targetType!=='æ··åˆ')
        ? targetType
        : (targetType==='æ··åˆ' ? weightedPick() : targetType);

      current = generateByType(type);
      qEl.textContent = `${current.a} Ã— ${current.b} = ?ã€€ï¼ˆ${current.type}ï¼‰`;
      tipEl.textContent = 'æç¤ºï¼šå…ˆè‡ªå·±è©¦è©¦çœ‹ï¼Œç­”éŒ¯æœƒé¡¯ç¤ºè§£æ³•ã€‚';
      renderOptions();
      updateProgress();
    }

    // æ··åˆæ™‚çš„é¡Œå‹æ¬Šé‡ï¼ˆé¿å…å¹¾ä¹éƒ½æ‹†åˆ†ï¼‰
    function weightedPick(){
      const bag = [
        'å¹³æ–¹å·®','å¹³æ–¹å·®','å¹³æ–¹å·®',
        'æ¥è¿‘100','æ¥è¿‘100',
        'å°¾æ•¸äº’è£œ','å°¾æ•¸äº’è£œ',
        'å°¾æ•¸5å¹³æ–¹',
        'å€æ•¸/ä¸€åŠ',
        'å¹³æ–¹',
        'æ‹†åˆ†','æ‹†åˆ†'
      ];
      return bag[Math.floor(Math.random()*bag.length)];
    }

    // é¡Œç›®ç”Ÿæˆï¼ˆä¾é¡Œå‹ï¼‰
    function generateByType(type){
      let a,b,tries=0;
      while(tries<500){
        tries++;
        a = randInt(10,99);
        b = randInt(10,99);

        if(type==='å°¾æ•¸5å¹³æ–¹'){ a = randPick([15,25,35,45,55,65,75,85,95]); b = a; }
        else if(type==='å¹³æ–¹'){ a = randInt(10,99); b = a; }
        else if(type==='æ¥è¿‘100'){ a = randInt(90,99); b = randInt(90,99); }
        else if(type==='å°¾æ•¸äº’è£œ'){
          const t = randInt(1,9);
          const u = randPick([1,2,3,4,5,6,7,8,9]);
          const v = 10-u;
          a = t*10 + u; b = t*10 + v;
        }
        else if(type==='å¹³æ–¹å·®'){
          const m = randPick([20,30,40,50,60,70,80,90]);
          const n = randPick([1,2,3,4]);
          a = m-n; b = m+n;
        }
        else if(type==='å€æ•¸/ä¸€åŠ'){
          if(Math.random()<0.4){ a = randPick([25,50]); b = randInt(10,99); }
          else{
            a = randPick([12,14,15,16,18,20,24,28,30,32,36,40,42,44,48]);
            b = randPick([12,14,15,16,18,20,24,28,30,32,36,40,42,44,48]);
          }
        }
        // æ‹†åˆ† or å…¶ä»–ï¼šä»»æ„å…©ä½æ•¸

        if( validateType(type,a,b) ){
          const ans = a*b;
          const {tip,type:finalType} = decideTip(a,b);
          return {a,b,ans,tip,type:finalType};
        }
      }
      const ans = a*b; const {tip,type:finalType} = decideTip(a,b);
      return {a,b,ans,tip,type:finalType};
    }

    function validateType(type,a,b){
      if(type==='å°¾æ•¸5å¹³æ–¹') return (a===b && a%10===5);
      if(type==='å¹³æ–¹')      return (a===b);
      if(type==='æ¥è¿‘100')   return (a>=90 && b>=90);
      if(type==='å°¾æ•¸äº’è£œ')  return (Math.floor(a/10)===Math.floor(b/10) && (a%10 + b%10===10));
      if(type==='å¹³æ–¹å·®')    return (Math.abs(a-b)===2 && ((a+b)%2===0));
      if(type==='å€æ•¸/ä¸€åŠ') return ( (a%2===0 && b%2===0) || (a%25===0 || b%25===0 || a%50===0 || b%50===0) || gcd(a,b)>1 );
      return true;
    }

    // å·¥å…·
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function gcd(x,y){ while(y){ [x,y]=[y,x%y]; } return x; }

    // ç”¢ç”Ÿã€Œå°åŠÃ—åŠ å€ã€æ­¥é©Ÿï¼ˆæœ€å¤š 4 æ­¥é¿å…å¤ªé•·ï¼›ä¿è­‰ä¸é‡è¤‡ï¼‰
    function halfDoubleSteps(a,b){
      let x=a, y=b, steps=[];
      let moves=0;
      while(x%2===0 && y%2===0 && x>1 && moves<4){
        const nx = x/2, ny = y*2;
        steps.push(`${x}Ã—${y} â†’ ${nx}Ã—${ny}`);
        x = nx; y = ny; moves++;
      }
      return {text: steps.length ? (`å°åŠÃ—åŠ å€ï¼š` + steps.join(' â†’ ')) : '', lastX:x, lastY:y};
    }

    // ===== æ ¸å¿ƒï¼šæ›´ç²¾æº–å¯è®€çš„ã€Œè§£æ³•ã€ç”¢ç”Ÿ =====
    function decideTip(a,b){
      const ans = a*b;

      // å°¾æ•¸ 5 çš„å¹³æ–¹ï¼šå‰Ã—(å‰+1) åšå‰åŠï¼Œå°¾å·´å›ºå®š 25ï¼Œçµ¦æœ€çµ‚ç­”æ¡ˆ
      if(a===b && a%10===5){
        const head = Math.floor(a/10);
        const front = head*(head+1);
        return { tip:`[å°¾æ•¸ 5] å‰ï¼š${head}Ã—(${head}+1)=${front}ï¼›å¾Œï¼š25 â†’ ${front}25 = ${ans}`, type:'å°¾æ•¸5å¹³æ–¹' };
      }

      // ä¸€èˆ¬å¹³æ–¹ï¼šé¸æœ€è¿‘æ•´å tï¼Œä¾ a èˆ‡ t çš„é—œä¿‚æ±ºå®š + æˆ– âˆ’ï¼Œç®—åˆ°æœ€å¾Œ
      if(a===b){
        const t = Math.round(a/10)*10;
        const d = Math.abs(a - t);
        if(a >= t){
          const p1 = t*t, p2 = 2*t*d, p3 = d*d;
          return { tip:`[å¹³æ–¹] (${t}+${d})Â² = ${t}Â² + 2Ã—${t}Ã—${d} + ${d}Â² = ${p1} + ${p2} + ${p3} = ${ans}`, type:'å¹³æ–¹' };
        }else{
          const p1 = t*t, p2 = 2*t*d, p3 = d*d;
          return { tip:`[å¹³æ–¹] (${t}âˆ’${d})Â² = ${t}Â² âˆ’ 2Ã—${t}Ã—${d} + ${d}Â² = ${p1} âˆ’ ${p2} + ${p3} = ${ans}`, type:'å¹³æ–¹' };
        }
      }

      // å°¾æ•¸äº’è£œï¼šå‰=åä½Ã—(åä½+1)ï¼Œå¾Œ=å€‹ä½ç›¸ä¹˜è£œæˆå…©ä½ï¼Œåˆä½µä¸¦çµ¦æœ€çµ‚ç­”æ¡ˆ
      if(Math.floor(a/10)===Math.floor(b/10) && (a%10 + b%10===10)){
        const t = Math.floor(a/10);
        const u = a%10, v = b%10;
        const front = t*(t+1);
        const back = u*v;
        const back2 = back.toString().padStart(2,'0');
        return { tip:`[å°¾æ•¸äº’è£œ] å‰ï¼š${t}Ã—(${t}+1)=${front}ï¼›å¾Œï¼š${u}Ã—${v}=${back}ï¼ˆè£œæˆå…©ä½ ${back2}ï¼‰â†’ ${front}${back2} = ${ans}`, type:'å°¾æ•¸äº’è£œ' };
      }

      // æ¥è¿‘100ï¼šå‰=100âˆ’(å·®å’Œ)ï¼Œå¾Œ=å·®ç©è£œå…©ä½ï¼Œåˆä½µä¸¦çµ¦æœ€çµ‚ç­”æ¡ˆ
      if(a>=90 && b>=90){
        const da = 100 - a, db = 100 - b;
        const front = 100 - (da + db);
        const back = da*db;
        const back2 = back.toString().padStart(2,'0');
        return { tip:`[æ¥è¿‘100] å‰ï¼š100âˆ’(${da}+${db})=${front}ï¼›å¾Œï¼š${da}Ã—${db}=${back}ï¼ˆè£œæˆå…©ä½ ${back2}ï¼‰â†’ ${front}${back2} = ${ans}`, type:'æ¥è¿‘100' };
      }

      // å¹³æ–¹å·®ï¼š (mâˆ’n)(m+n)=mÂ²âˆ’nÂ²ï¼Œç®—åˆ°æœ€å¾Œ
      if( Math.abs(a-b)===2 && ((a+b)%2===0) ){
        const m = (a+b)/2, n = Math.abs(a-b)/2;
        const p1 = m*m, p2 = n*n;
        return { tip:`[å¹³æ–¹å·®] (${m}âˆ’${n})(${m}+${n}) = ${m}Â² âˆ’ ${n}Â² = ${p1} âˆ’ ${p2} = ${ans}`, type:'å¹³æ–¹å·®' };
      }

      // å€æ•¸/ä¸€åŠï¼šä¸‰è·¯åˆ†æµï¼ˆå¶æ•¸å°åŠï¼›25/50 ä¸”å¯æ•´é™¤ï¼›æˆ–å…ˆæå…¬å› æ•¸ï¼‰ï¼Œéƒ½ç®—åˆ°æœ€å¾Œ
      const g = gcd(a,b);

      // 1) å…©æ•¸çš†å¶æ•¸ â†’ å°åŠÃ—åŠ å€ï¼ˆé€£çºŒï¼‰ï¼Œæœ€å¾Œçµ¦å‡ºç­‰æ–¼ä¹˜ç©
      if(a%2===0 && b%2===0){
        const {text, lastX, lastY} = halfDoubleSteps(a,b);
        const tail = text ? `${text} â†’ ${lastX}Ã—${lastY} = ${ans}` : `${a}Ã—${b} = ${ans}`;
        return { tip:`[å€æ•¸/ä¸€åŠ] ${tail}`, type:'å€æ•¸/ä¸€åŠ' };
      }

      // 2) æœ‰ 25 æˆ– 50ï¼Œä¸”å¦ä¸€é‚Šå¯æ•´é™¤ â†’ å±•é–‹æ•´ç™¾æ€è€ƒ
      if(a%25===0 || b%25===0 || a%50===0 || b%50===0){
        // å„ªå…ˆè™•ç† 50ï¼šå¦ä¸€é‚Šæ˜¯å¶æ•¸å°±å¥½
        if(a%50===0 && b%2===0){
          const k = a/50;
          return { tip:`[å€æ•¸/ä¸€åŠ] 50=100Ã·2 â†’ ${a}Ã—${b} = (${k}Ã—50)Ã—${b} = ${k}Ã—(100Ã—${b}/2) = 100Ã—${k*b/2} = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
        }
        if(b%50===0 && a%2===0){
          const k = b/50;
          return { tip:`[å€æ•¸/ä¸€åŠ] 50=100Ã·2 â†’ ${a}Ã—${b} = ${a}Ã—(${k}Ã—50) = ${k}Ã—(100Ã—${a}/2) = 100Ã—${k*a/2} = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
        }
        // å†è™•ç† 25ï¼šå¦ä¸€é‚Šéœ€å¯è¢« 4 æ•´é™¤
        if(a%25===0 && b%4===0){
          const k = a/25;
          return { tip:`[å€æ•¸/ä¸€åŠ] 25=100Ã·4 â†’ ${a}Ã—${b} = (${k}Ã—25)Ã—${b} = 100Ã—(${k*b/4}) = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
        }
        if(b%25===0 && a%4===0){
          const k = b/25;
          return { tip:`[å€æ•¸/ä¸€åŠ] 25=100Ã·4 â†’ ${a}Ã—${b} = ${a}Ã—(${k}Ã—25) = 100Ã—(${k*a/4}) = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
        }
        // è‹¥ç„¡æ³•æ•´é™¤ï¼Œå°±æ”¹èµ°æå…¬å› æ•¸ï¼Œé¿å…å‡ºç¾åˆ†æ•¸
        if(g>1){
          const m = a/g, n = b/g;
          return { tip:`[å€æ•¸/ä¸€åŠ] å…ˆæå…¬å› æ•¸ï¼š${a}Ã—${b} = (${g}Ã—${m})Ã—(${g}Ã—${n}) = ${g}Â²Ã—(${m}Ã—${n}) = ${g*g}Ã—${m*n} = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
        }
      }

      // 3) ä¸€èˆ¬æƒ…æ³ï¼šè‹¥æœ‰å…¬å› æ•¸å°±å…ˆæå…¬å› æ•¸ï¼Œå¦å‰‡èµ°æ‹†åˆ†
      if(g>1){
        const m = a/g, n = b/g;
        return { tip:`[å€æ•¸/ä¸€åŠ] å…ˆæå…¬å› æ•¸ï¼š${a}Ã—${b} = (${g}Ã—${m})Ã—(${g}Ã—${n}) = ${g}Â²Ã—(${m}Ã—${n}) = ${g*g}Ã—${m*n} = ${ans}`, type:'å€æ•¸/ä¸€åŠ' };
      }

      // æ‹†åˆ† fallbackï¼ˆåˆ—å‡ºå±•é–‹å¼ï¼‰
      const aT=Math.floor(a/10), aU=a%10, bT=Math.floor(b/10), bU=b%10;
      const p1 = (aT*10)*(bT*10), p2=(aT*10)*bU, p3=aU*(bT*10), p4=aU*bU;
      return { tip:`[æ‹†åˆ†] (${aT}0+${aU})Ã—(${bT}0+${bU}) = ${p1} + ${p2} + ${p3} + ${p4} = ${ans}`, type:'æ‹†åˆ†' };
    }

    // å»ºç«‹é¸é …ï¼ˆå«æ­£è§£ + å¹²æ“¾ï¼‰
    function buildOptions(ans){
      const s = new Set([ans]);
      while(s.size<2){ s.add(ans + randInt(-25,25)); }
      const rounded = Math.round(ans/10)*10; if(rounded>0) s.add(rounded);
      if(ans>99) s.add(ans - (ans%10||10));
      s.add(ans + (10*(randInt(-2,2))));
      let arr = Array.from(s).filter(x=>x>0);
      while(arr.length<4){
        const w = ans + randInt(-40,40);
        if(w>0 && !arr.includes(w)) arr.push(w);
      }
      arr = arr.slice(0,4);
      return arr.sort(()=>Math.random()-0.5);
    }

    // å‡ºé¡Œèˆ‡ä½œç­”
    function renderOptions(){
      const ops = buildOptions(current.ans);
      optsEl.innerHTML = '';
      ops.forEach(val=>{
        const btn = document.createElement('button');
        btn.className = 'option';
        btn.textContent = val;
        btn.addEventListener('click', ()=> choose(val, btn));
        optsEl.appendChild(btn);
      });
    }

    function choose(val, btn){
      if(locked) return;
      locked = true;

      const all = Array.from(document.querySelectorAll('button.option'));
      const correctBtn = all.find(b => Number(b.textContent) === current.ans);

      if(val === current.ans){
        btn.classList.add('correct');
        if(mode==='exam'){
          const perQ = perScoreFor(examTotal);
          score += perQ; // ç­”å°æ‰åŠ åˆ†
        }
        streak += 1;
        tipEl.innerHTML = `âœ… ç­”å°ï¼${mode==='exam'?`æœ¬é¡Œ +${perScoreFor(examTotal)} åˆ†ã€€`:''}<span class="muted">ğŸ”¥ é€£å° ${streak} é¡Œï¼</span>`;
      }else{
        btn.classList.add('wrong');
        if(correctBtn) correctBtn.classList.add('correct');
        streak = 0;
        tipEl.innerHTML = `âŒ ç­”éŒ¯ï¼<br>è§£æ³•ï¼š${current.tip}`;
        if(mode==='exam'){
          wrongLog.push({ q:`${current.a} Ã— ${current.b}`, type: current.type, your: val, ans: current.ans, tip: current.tip });
        }
      }

      renderScore();

      if(mode==='exam'){
        counter += 1; updateProgress();
        setTimeout(()=>{
          if(counter >= examTotal){
            endExam();
          }else{
            newQuestion();
          }
        }, 600);
      }else{
        setTimeout(()=>{ locked=false; }, 200);
      }
    }

    function endExam(){
      locked = true;
      document.querySelectorAll('button.option').forEach(b=>b.disabled=true);
      const finalScore = Math.round(score); // ç™¾åˆ†åˆ¶æ•´æ•¸
      qEl.textContent = `æ¸¬é©—çµæŸï¼ä½ çš„åˆ†æ•¸ï¼š${finalScore} / 100ï¼ˆå…± ${examTotal} é¡Œï¼‰`;
      tipEl.innerHTML = `ä¸‹æ–¹åˆ—å‡ºæœ¬æ¬¡æ¸¬é©—çš„éŒ¯é¡Œèˆ‡è§£æ³•ï¼Œå¯æŒ‰ã€ŒåŒ¯å‡ºéŒ¯é¡Œ CSVã€ã€‚`;
      showReview();
    }

    // å›é¡§
    function showReview(){
      reviewSec.style.display = 'block';
      reviewList.innerHTML = '';
      if(wrongLog.length === 0){
        reviewEmpty.style.display = 'block';
        return;
      }
      reviewEmpty.style.display = 'none';
      wrongLog.forEach((it, idx)=>{
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
          <div class="q">#${idx+1}ã€€${it.q}ã€€<span class="muted">ï¼ˆ${it.type}ï¼‰</span></div>
          <div>ä½ çš„ç­”æ¡ˆï¼š<span class="you">${it.your}</span>ã€€ï½œã€€æ­£ç¢ºï¼š<span class="ans">${it.ans}</span></div>
          <div class="how">è§£æ³•ï¼š${it.tip}</div>
        `;
        reviewList.appendChild(div);
      });
      reviewSec.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // åŒ¯å‡ºéŒ¯é¡Œ CSV
    function exportWrongCSV(){
      if(!wrongLog.length){
        alert('é€™æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯é¡Œå¯åŒ¯å‡ºã€‚');
        return;
      }
      const header = ['é¡Œç›®','é¡Œå‹','ä½ çš„ç­”æ¡ˆ','æ­£ç¢ºç­”æ¡ˆ','è§£æ³•'];
      const rows = wrongLog.map(r => [r.q, r.type, String(r.your), String(r.ans), r.tip]);
      const csv = [header, ...rows].map(row => row.map(csvEscape).join(',')).join('\r\n');
      const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'wrong_questions.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function csvEscape(val){
      const s = (val ?? '').toString().replace(/\r?\n/g,'  ');
      return /[",]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }
  </script>
</body>
</html>
